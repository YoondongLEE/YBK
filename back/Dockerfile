FROM python:3.9-slim

WORKDIR /app

# ÏãúÏä§ÌÖú Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Python ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏΩîÎìú Î≥µÏÇ¨
COPY . .

# DATABASE_URL ÏÇ¨Ïö©ÌïòÎäî Í∞úÏÑ†Îêú Ïä§ÌÅ¨Î¶ΩÌä∏
RUN echo '#!/bin/bash\n\
set -e\n\
echo "üöÄ Railway Î∞∞Ìè¨ ÏãúÏûë..."\n\
echo "üîç DATABASE_URL ÌôïÏù∏: ${DATABASE_URL:0:30}..."\n\
if [ -z "$DATABASE_URL" ]; then\n\
  echo "‚ùå DATABASE_URLÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!"\n\
  exit 1\n\
fi\n\
echo "‚è≥ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏..."\n\
python -c "import dj_database_url, psycopg2; db_config = dj_database_url.parse(\"$DATABASE_URL\"); psycopg2.connect(**db_config); print(\"‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÏÑ±Í≥µ\")" || {\n\
  echo "‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ Ïã§Ìå®. Ïû¨ÏãúÎèÑ Ï§ë..."\n\
  sleep 5\n\
  python -c "import dj_database_url, psycopg2; db_config = dj_database_url.parse(\"$DATABASE_URL\"); psycopg2.connect(**db_config); print(\"‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÏÑ±Í≥µ (Ïû¨ÏãúÎèÑ)\")" || {\n\
    echo "‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÏµúÏ¢Ö Ïã§Ìå®"\n\
    exit 1\n\
  }\n\
}\n\
echo "üîß ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ..."\n\
python manage.py migrate\n\
echo "‚úÖ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å"\n\
echo "üìÅ Ï†ïÏ†Å ÌååÏùº ÏàòÏßë..."\n\
python manage.py collectstatic --noinput\n\
echo "‚úÖ Ï†ïÏ†Å ÌååÏùº ÏàòÏßë ÏôÑÎ£å"\n\
echo "üî• ÏÑúÎ≤Ñ ÏãúÏûë..."\n\
exec "$@"' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Ìè¨Ìä∏ ÏÑ§Ï†ï
EXPOSE 8000

ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000"]